<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Özel Çark Çevirme Uygulaması</title>
    <style>
        /* Basit CSS stilleri */
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        #app-content { max-width: 800px; margin: auto; }
        #auth-ui input { padding: 10px; margin: 5px; }
        #auth-ui button, #logout-button, #spin-button { padding: 10px 20px; cursor: pointer; }
        #wheel-container { margin: 20px 0; border: 1px solid #ccc; display: inline-block; }
        #wheel-canvas { background-color: #eee; border-radius: 50%; }
        #results-list { list-style: none; padding: 0; }
        #results-list li { background: #f4f4f4; margin: 5px 0; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Özel Çark Çevirme Uygulaması</h1>

    <div id="auth-ui">
        <h2>Giriş Yapın</h2>
        <input type="email" id="email" placeholder="E-posta">
        <input type="password" id="password" placeholder="Şifre">
        <button id="login-button">Giriş Yap</button>
        <p id="auth-error" style="color: red;"></p>
    </div>

    <div id="app-content" style="display:none;">
        <h2>Merhaba, Yönetici! Uygulama Verileri:</h2>
        
        <div id="wheel-container">
            <canvas id="wheel-canvas" width="400" height="400"></canvas>
            <button id="spin-button">Çevir!</button>
        </div>
        
        <h3>Sonuç Kayıtları (Firebase'den)</h3>
        <ul id="results-list">
            <li>Yükleniyor...</li>
        </ul>

        <button id="logout-button">Çıkış Yap</button>
    </div>

    <script type="module">
        // --- 1. Firebase Modüllerini İçe Aktar ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        // --- 2. GÖRSELDEKİ BİLGİLERİNİZ VE KENDİ UID'NİZ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCxV9J8v9b53HpzVgWOiEF-_FHwejPo",
            authDomain: "anit-885a2.firebaseapp.com",
            projectId: "anit-885a2",
            storageBucket: "anit-885a2.appspot.com",
            messagingSenderId: "840387116828",
            appId: "1:840387116828:web:0887b37d998cb63a35c4d9",
            measurementId: "G-R0BY4RSPBB",
            // Realtime Database URL'nizi buraya ekleyin:
            databaseURL: "https://anit-885a2-default-rtdb.firebaseio.com" 
        };

        // BURAYI KENDİ UID'NİZ İLE DEĞİŞTİRİN!
        const MY_USER_UID = "yya21vML6kSIh2fttsg8VNFNcex1"; 

        // --- 3. Firebase Servislerini Başlat ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // DOM Elementleri
        const authUI = document.getElementById('auth-ui');
        const appContent = document.getElementById('app-content');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const resultsList = document.getElementById('results-list');
        const spinButton = document.getElementById('spin-button');

        // Çark Dilimleri
        const slices = ["5 Puan", "10 Puan", "Kaybettin", "25 Puan", "Tekrar Çevir", "0 Puan"];
        const colors = ["#ffc107", "#28a745", "#dc3545", "#007bff", "#6f42c1", "#343a40"];
        const canvas = document.getElementById('wheel-canvas');
        const ctx = canvas.getContext('2d');
        let currentRotation = 0;

        // --- 4. Fonksiyonlar ---
        
        // Veri Kaydetme
        function saveSpinResult(uid, result) {
            const resultsRef = ref(db, `users/${uid}/spin_results`);
            push(resultsRef, {
                result: result,
                timestamp: serverTimestamp()
            }).then(() => {
                console.log("Sonuç Firebase'e başarıyla kaydedildi.");
            }).catch(error => {
                console.error("Veri kaydetme hatası:", error);
            });
        }

        // Veri Yükleme (Realtime)
        function loadSpinResults(uid) {
            const resultsRef = ref(db, `users/${uid}/spin_results`);
            
            onValue(resultsRef, (snapshot) => {
                resultsList.innerHTML = '';
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // Sonuçları en yenisi en üstte olacak şekilde sıralama
                    const sortedResults = Object.entries(data).sort(([, a], [, b]) => b.timestamp - a.timestamp);
                    
                    sortedResults.forEach(([, item]) => {
                        const li = document.createElement('li');
                        const date = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'Hemen şimdi';
                        li.textContent = `[${date}] - Çark Sonucu: ${item.result}`;
                        resultsList.appendChild(li);
                    });
                } else {
                    resultsList.innerHTML = '<li>Henüz bir sonuç kaydedilmedi.</li>';
                }
            });
        }

        // Çarkı Çizme Fonksiyonu
        function drawWheel(rotation = 0) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = centerX - 5;
            const arc = (2 * Math.PI) / slices.length;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(rotation);
            
            slices.forEach((slice, i) => {
                const angle = i * arc;
                
                // Dilimi Çiz
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.closePath();
                ctx.fill();

                // Metni Yaz
                ctx.save();
                ctx.rotate(angle + arc / 2);
                ctx.fillStyle = 'black';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(slice, radius - 10, 5);
                ctx.restore();
            });

            ctx.restore();

            // Orta daireyi çiz
            ctx.beginPath();
            ctx.fillStyle = 'white';
            ctx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
            ctx.fill();

            // İşaretçi (Ok)
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.moveTo(centerX * 2 - 10, centerY);
            ctx.lineTo(centerX * 2, centerY - 10);
            ctx.lineTo(centerX * 2, centerY + 10);
            ctx.closePath();
            ctx.fill();
        }

        // Çevirme Animasyonu
        function spinWheel() {
            spinButton.disabled = true;
            authError.textContent = "Çark çevriliyor...";
            
            // Rastgele bir duruş açısı hesapla (en az 4 tam tur)
            const minTurns = 4;
            const randomSliceIndex = Math.floor(Math.random() * slices.length);
            const targetAngle = randomSliceIndex * (360 / slices.length);
            const totalDegrees = (minTurns * 360) + (360 - targetAngle); // Başlangıçtan hedefe dönme
            const duration = 5000; // 5 saniye
            const startTime = performance.now();

            function animate(currentTime) {
                const elapsedTime = currentTime - startTime;
                const progress = Math.min(elapsedTime / duration, 1);
                
                // Yavaşlama (Ease out cubic)
                const easing = 1 - Math.pow(1 - progress, 3); 
                
                const rotationDegrees = totalDegrees * easing;
                currentRotation = (rotationDegrees * Math.PI) / 180; // Radyana çevir
                drawWheel(currentRotation);

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Animasyon bitti, sonucu belirle ve kaydet
                    spinButton.disabled = false;
                    authError.textContent = "Sonuç belli oldu!";
                    const winningSlice = slices[randomSliceIndex];
                    alert(`Çark sonucu: ${winningSlice}!`);
                    saveSpinResult(auth.currentUser.uid, winningSlice);
                }
            }
            requestAnimationFrame(animate);
        }

        // --- 5. Olay Dinleyicileri (Events) ---

        // A. Yetkilendirme Durumu Değiştiğinde
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.uid === MY_USER_UID) {
                    // Kendi Yöneticinizsiniz!
                    authUI.style.display = 'none';
                    appContent.style.display = 'block';
                    authError.textContent = "";
                    drawWheel(); // Çarkı başlangıçta çiz
                    loadSpinResults(user.uid);
                } else {
                    // Yetkisiz kullanıcı giriş yaparsa
                    alert("Bu siteye erişim yetkiniz yok.");
                    signOut(auth);
                    authUI.style.display = 'block';
                    appContent.style.display = 'none';
                }
            } else {
                // Oturum Açılmamış
                authUI.style.display = 'block';
                appContent.style.display = 'none';
                authError.textContent = "Lütfen yönetici hesabı ile giriş yapın.";
            }
        });

        // B. Giriş Düğmesi
        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = "Giriş yapılıyor...";
            
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    authError.textContent = "Giriş başarısız: " + error.message;
                });
        });

        // C. Çıkış Düğmesi
        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // D. Çevir Düğmesi
        spinButton.addEventListener('click', spinWheel);

        // İlk çark çizimini yap
        drawWheel(); 
    </script>
</body>
</html>
